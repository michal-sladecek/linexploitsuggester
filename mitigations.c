#include <stdio.h>
#include "print.h"
#include "mitigations.h"

int mmap_min_addr = 0;
int readable_kallsyms = 0;

void determine_mmap_min_addr(){
  // mmap_min_addr mitigates against exploits which exploit NULL ptr dereference
  // Some exploits can bypass this though
  FILE * fptr;
  fptr = fopen("/proc/sys/vm/mmap_min_addr", "r");
  if(fptr == NULL){
    mmap_min_addr = 0;
  }
  fscanf(fptr,"%d", &mmap_min_addr);
  fclose(fptr);
}

void determine_readable_kallsyms(){
  // Some exploits need kallsyms file to be readable.
  // After commit https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=455cd5ab305c90ffc422dd2e0fb634730942b257,
  // the kallsyms is readable but contains only zeroes, which also
  // mitigates against those exploits.

  FILE * fptr;
  fptr = fopen("/proc/kallsyms", "r");
  if(fptr == NULL){
    readable_kallsyms = 0;
  }
  // We go through the kallsyms file, if we find one pointer which is non zero
  // we return that kallsyms might be used.
  for(int i=0;i<100;++i){
    char sname[256];
    char dummy;
    void * ptr;
    if(fscanf(fptr,"%p %c %s", &ptr, &dummy, sname) == EOF){
      break;
    }
    if(ptr != NULL){
      readable_kallsyms = 1;
      break;
    }
  }
}

int init_mitigations(){
  determine_mmap_min_addr();
  determine_readable_kallsyms();
}

void print_mitigations(){
  if(mmap_min_addr != 0) printRed("mmap_min_addr is in use.\n");
  else printGreen("mmap_min_addr is not in use.\n");
  if(readable_kallsyms) printGreen("Exploits can use kallsyms\n");
  else printRed("Exploits cannot use kallsyms.\n");

}
