#include <sys/socket.h>
#include <unistd.h>
#include <stdio.h>
#include "print.h"

#define REGISTER_EXPLOIT(NAME) if(exploit_ ## NAME ## _test() == 1) exploit_ ##NAME ## _info();

extern int kern_version, kern_major, kern_minor, mmap_min_addr;

int exploit_sock_sendpage_test(){
  if(kern_version == 2 && ((kern_major == 4 && kern_minor >= 4 && kern_minor <=37) || (kern_major == 6 && kern_minor >= 0 && kern_minor <=30 ))){
    int fd;
    if((fd = socket(PF_BLUETOOTH, SOCK_DGRAM, 0)) == -1){
      if((fd=socket(PF_APPLETALK,SOCK_DGRAM,0))==-1){
        return 0;
      }
    }
    close(fd);
    return 1;
  }
  return 0;
}

void exploit_sock_sendpage_info(){
  printGreen("[+]");
  printf("sock_sendpage exploit might be possible\n");
  printf("\tMSF module:\texploit/linux/local/sock_sendpage\n");
  printf("\tEDB exploits:\t9545,9479\n");
  printf("\tKeywords:\twunderbar_emporium, CVE-2009-2692\n");
  if(mmap_min_addr != 0){
    printf("\tExploit claimes to be able to bypass NULL page protection, but it might not.\n");
  }
}



void try_exploits(){
  REGISTER_EXPLOIT(sock_sendpage);
}
