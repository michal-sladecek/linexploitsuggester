#include <sys/socket.h>
#include <unistd.h>
#include <stdio.h>
#include "print.h"

#define REGISTER_EXPLOIT(NAME) if(exploit_ ## NAME ## _test() == 1){ printGreen("[+]"); exploit_ ##NAME ## _info();}

extern int kern_version, kern_major, kern_minor, mmap_min_addr;


int exploit_sock_sendpage_test(){
  if(kern_version == 2 && ((kern_major == 4 && kern_minor >= 4 && kern_minor <=37) || (kern_major == 6 && kern_minor >= 0 && kern_minor <=30 ))){
    int fd;
    if((fd = socket(PF_BLUETOOTH, SOCK_DGRAM, 0)) == -1){
      if((fd=socket(PF_APPLETALK,SOCK_DGRAM,0))==-1){
        return 0;
      }
    }
    close(fd);
    return 1;
  }
  return 0;
}

void exploit_sock_sendpage_info(){
  printf("sock_sendpage exploit might be possible\n");
  printf("\tMSF module:\texploit/linux/local/sock_sendpage\n");
  printf("\tEDB exploits:\t9545,9479\n");
  printf("\tKeywords:\twunderbar_emporium, CVE-2009-2692\n");
  if(mmap_min_addr != 0){
    printf("\tExploit claimes to be able to bypass NULL page protection, but it might not.\n");
  }
}



int exploit_full_nelson_test(){
  if(kern_version==2 && kern_major==6 && kern_minor>=31 && kern_minor <= 37)
  {
    int fd;
    if((fd = socket(PF_ECONET, SOCK_DGRAM, 0)) == -1){
        return 0;
    }
    close(fd);
    return 1;
  }
  return 0;
}
void exploit_full_nelson_info(){
  printf("full_nelson exploit might be possible\n");
  printf("\tEDB exploits:\t15704\n");
  printf("\tKeywords: CVE-2010-3849,CVE-2010-3850,CVE-2010-4258\n");
}


int exploit_dirty_cow_test(){
  if(kern_version==2 && kern_major>=6 && kern_minor>=22){
    return 1;
  }
  if(kern_version==3 && kern_major<=9){
    return 1;
  }
  return 0;
}

void exploit_dirty_cow_info(){
  printf("dirty_cow exploit might be possible\n");
  printf("\tEDB exploits:\t40839,40616,40847\n");
  printf("\tKeywords: CVE-2016-5195\n");
}


/*
 * This is a race condition, it will probably not work on single core machine with
 * CONFIG_PREEMPT_NONE=y - need to consult.
 * */
int exploit_pipe_c_test(){
  if(kern_version==2 && kern_major==4 && kern_minor>=4 && kern_minor <= 37){
    return 1;
  }
  if(kern_version==2 && kern_major==6 && kern_minor >= 10 && kern_minor <= 31){
    return 1;
  }
  //TODO test for number of cores
  return 0;
}
void exploit_pipe_c_info(){
  printf("pipe.c exploit might be possible\n");
  printf("\tEDB exploits: 40812,33322\n");
  printf("\tYou need to use enlightement framework for 40812 though - (https://github.com/packetforger/localroot/tree/master/third-party/enlightenment)\n");
  printf("\tKeywords: CVE-2009-3547\n");
  if(mmap_min_addr != 0){
    printf("\tEDB 40812 might bypass mmap_min_addr\n");
    printf("\tDon\'t use 33322, cant mmap null page.\n");
  }
}

void try_exploits(){
  REGISTER_EXPLOIT(sock_sendpage);
  REGISTER_EXPLOIT(full_nelson);
  REGISTER_EXPLOIT(dirty_cow);
}
